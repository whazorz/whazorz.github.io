<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WDESIGN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .nav-btn.active {
            @apply bg-indigo-700 text-white;
        }
        /* Styles for the gallery slideshow */
        .slide {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .slide.active {
            display: block;
        }
        /* NEW: Styles for logged-out nav */
        .auth-nav-btn {
            @apply p-2 rounded-lg font-medium text-gray-700 dark:text-gray-300 hover:bg-indigo-100 dark:hover:bg-gray-700;
        }
        .auth-nav-btn.active {
            @apply bg-indigo-700 text-white;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex items-center justify-center min-h-full p-4 font-sans">

    <div class="w-full max-w-md">
        
        <div id="app-content">

            <div id="loading-container" class="text-center p-10">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Loading...</h2>
            </div>
            
            <div id="logged-out-container" class="hidden">
                <nav class="bg-white dark:bg-gray-800 shadow-lg rounded-2xl p-4 flex justify-around items-center mb-6">
                    <button id="auth-nav-gallery" class="auth-nav-btn flex-1 text-center">
                        Gallery
                    </button>
                    <button id="auth-nav-login" class="auth-nav-btn flex-1 text-center">
                        Sign In
                    </button>
                </nav>

                <div id="auth-container" class="hidden bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 sm:p-10">
                    <div class="text-center">
                        <h2 id="form-title" class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white">Sign in to your account</h2>
                        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                            Or
                            <button id="toggle-form" class="font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">
                                create a new account
                            </button>
                        </p>
                    </div>

                    <form id="auth-form" class="mt-8 space-y-6">
                        <div class="rounded-md shadow-sm -space-y-px">
                            <div>
                                <label for="email" class="sr-only">Email address</label>
                                <input id="email" name="email" type="email" autocomplete="email" required
                                    class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 placeholder-gray-500 text-gray-900 dark:text-white rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                                    placeholder="Email address">
                            </div>
                            <div id="password-field">
                                <label for="password" class="sr-only">Password</label>
                                <input id="password" name="password" type="password" autocomplete="current-password" required minlength="6"
                                    class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 placeholder-gray-500 text-gray-900 dark:text-white rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                                    placeholder="Password (min. 6 characters)">
                            </div>
                        </div>

                        <div class="flex items-center justify-end">
                            <div class="text-sm">
                                <button type="button" id="forgot-password-btn" class="font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">
                                    Forgot your password?
                                </button>
                            </div>
                        </div>

                        <div>
                            <button type="submit" id="submit-button"
                                class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                                <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                                    <svg class="h-5 w-5 text-indigo-500 group-hover:text-indigo-400" xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd"
                                            d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </span>
                                Sign In
                            </button>
                        </div>
                    </form>
                    
                    <div id="message-box" class="hidden fade-in mt-4 p-4 rounded-md text-sm"></div>
                </div>

                <div id="gallery-view" class="app-view hidden space-y-4 bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 sm:p-10">
                    <h2 class="text-2xl font-bold text-center text-gray-900 dark:text-white">Commission Gallery</h2>
                    
                    <div id="slideshow-container" class="relative w-full">
                        <div id="gallery-loading" class="text-center text-gray-500">Loading gallery...</div>
                        
                        <button id="prev-slide" class="absolute top-1/2 left-0 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full">
                            &#10094;
                        </button>
                        <button id="next-slide" class="absolute top-1/2 right-0 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full">
                            &#10095;
                        </button>
                    </div>
                    <p id="slide-description" class="text-center text-gray-600 dark:text-gray-400 italic"></p>
                </div>
            </div>

            <div id="app-container" class="hidden w-full max-w-2xl">
                <nav class="bg-white dark:bg-gray-800 shadow-lg rounded-2xl p-4 flex justify-around items-center mb-6">
                    <button id="nav-gallery" class="nav-btn flex-1 text-center p-2 rounded-lg font-medium text-gray-700 dark:text-gray-300 hover:bg-indigo-100 dark:hover:bg-gray-700">
                        Gallery
                    </button>
                    <button id="nav-profile" class="nav-btn flex-1 text-center p-2 rounded-lg font-medium text-gray-700 dark:text-gray-300 hover:bg-indigo-100 dark:hover:bg-gray-700">
                        Profile
                    </button>
                    <button id="nav-admin" class="nav-btn hidden flex-1 text-center p-2 rounded-lg font-medium text-yellow-600 dark:text-yellow-400 hover:bg-yellow-100 dark:hover:bg-gray-700">
                        Admin
                    </button>
                    <button id="logout-button" class="flex-1 text-center p-2 rounded-lg font-medium text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-gray-700">
                        Sign Out
                    </button>
                </nav>

                <main class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 sm:p-10">
                    
                    <div id="profile-view" class="app-view space-y-4">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Your Profile</h2>
                        <div>
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Email</p>
                            <p id="profile-email" class="text-lg font-semibold text-indigo-600 dark:text-indigo-400 break-words"></p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">User ID</p>
                            <p id="profile-uid" class="text-xs font-mono text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded p-2 break-all"></p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Your Coins</p>
                            <p class="flex items-center">
                                <span id="profile-coins" class="text-3xl font-bold text-green-600 dark:text-green-400">--</span>
                            </p>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                             <h3 class="text-lg font-medium text-gray-900 dark:text-white">Buy Coins</h3>
                             <div class="mt-2 p-4 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded-lg">
                                 <p class="font-bold">This is a placeholder.</p>
                                 <p class="text-sm">Securely processing payments (with Stripe or PayPal) requires a backend. This must be done with **Firebase Functions** to protect against fraud.</p>
                             </div>
                             <button id="buy-coins-btn-100" class="mt-4 w-full py-2 px-4 rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50" disabled>
                                 Buy 100 Coins (Coming Soon)
                             </button>
                        </div>
                    </div>

                    <div id="admin-view" class="app-view hidden space-y-6">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Admin Panel</h2>
                        
                        <div class="space-y-2">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Upload to Gallery</h3>
                            <form id="gallery-upload-form" class="space-y-2">
                                <input id="gallery-image-input" type="file" accept="image/*" required class="block w-full text-sm text-gray-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-full file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-indigo-50 file:text-indigo-700
                                  hover:file:bg-indigo-100"/>
                                <input id="gallery-description-input" type="text" placeholder="Image description (e.g., 'Logo for Client X')" required class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md sm:text-sm">
                                <button type="submit" id="gallery-upload-btn" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50">
                                    Upload Image
                                </button>
                            </form>
                            <div id="gallery-upload-message" class="hidden fade-in mt-2 p-3 rounded-md text-sm"></div>
                        </div>
                        
                        <div class="space-y-2">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Manage Coins</h3>
                            <input id="admin-user-id" type="text" placeholder="User ID" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md sm:text-sm">
                            <input id="admin-coin-amount" type="number" placeholder="Amount to Add (e.g., 50 or -10)" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md sm:text-sm">
                            <button id="admin-add-coins-btn" class="w-full py-2 px-4 rounded-md text-white bg-green-600 hover:bg-green-700 disabled:opacity-50">
                                Add Coins
                            </button>
                        </div>

                        <div class="space-y-2">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">All Users</h3>
                            <div id="admin-users-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                <p id="admin-no-users" class="text-gray-500 dark:text-gray-400">Loading users...</p>
                            </div>
                        </div>

                    </div>

                </main>
            </div>

        </div>

        <p class="mt-6 text-center text-xs text-gray-500 dark:text-gray-400">
            Secure login system
        </p>

    </div>


    <script type="module">
        // 3. Import functions from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            collection,
            onSnapshot,
            serverTimestamp,
            query,
            orderBy,
            deleteDoc,
            updateDoc,
            increment,
            addDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- 4. YOUR FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBEMeJPJ6xNhHtbPZVo4q8SWxDzYZy5x4s",
            authDomain: "wdesign-9e502.firebaseapp.com",
            projectId: "wdesign-9e502",
            storageBucket: "wdesign-9e502.firebasestorage.app",
            messagingSenderId: "666272519163",
            appId: "1:666272519163:web:12d530dedfde48d2eb715e",
            measurementId: "G-7G6P6WVVP8"
        };
        
        // 5. Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- 6. Get UI Elements ---
        const loadingContainer = document.getElementById('loading-container');
        const loggedOutContainer = document.getElementById('logged-out-container'); // NEW
        const appContainer = document.getElementById('app-container');
        
        // Auth Elements
        const authContainer = document.getElementById('auth-container');
        const authForm = document.getElementById('auth-form');
        const toggleFormBtn = document.getElementById('toggle-form');
        const formTitle = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-button');
        const messageBox = document.getElementById('message-box');
        const passwordField = document.getElementById('password-field');
        const passwordInput = document.getElementById('password');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');

        // Logged-out Nav
        const authNavGallery = document.getElementById('auth-nav-gallery');
        const authNavLogin = document.getElementById('auth-nav-login');

        // App UI Elements
        const navButtons = {
            gallery: document.getElementById('nav-gallery'),
            profile: document.getElementById('nav-profile'),
            admin: document.getElementById('nav-admin')
        };
        const appViews = {
            gallery: document.getElementById('gallery-view'),
            profile: document.getElementById('profile-view'),
            admin: document.getElementById('admin-view')
        };
        const logoutButton = document.getElementById('logout-button');

        // Profile View Elements
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileCoins = document.getElementById('profile-coins');

        // Admin View Elements
        const adminUserIdInput = document.getElementById('admin-user-id');
        const adminCoinAmountInput = document.getElementById('admin-coin-amount');
        const adminAddCoinsBtn = document.getElementById('admin-add-coins-btn');
        const adminUsersList = document.getElementById('admin-users-list');
        const adminNoUsers = document.getElementById('admin-no-users');
        const galleryUploadForm = document.getElementById('gallery-upload-form');
        const galleryImageInput = document.getElementById('gallery-image-input');
        const galleryDescriptionInput = document.getElementById('gallery-description-input');
        const galleryUploadBtn = document.getElementById('gallery-upload-btn');
        const galleryUploadMessage = document.getElementById('gallery-upload-message');

        // Gallery View Elements
        const galleryView = document.getElementById('gallery-view'); // NEW
        const slideshowContainer = document.getElementById('slideshow-container');
        const galleryLoading = document.getElementById('gallery-loading');
        const prevSlideBtn = document.getElementById('prev-slide');
        const nextSlideBtn = document.getElementById('next-slide');
        const slideDescription = document.getElementById('slide-description');
        

        let isLoginMode = true;
        let isForgotPasswordMode = false;
        let currentUserId = null;
        let currentUserData = null;
        let listenersUnsubscribe = [];
        
        let galleryImages = [];
        let currentSlideIndex = 0;
        let galleryListenerUnsub = null; // NEW: Specific listener for gallery

        // --- 7. Utility Functions ---
        
        function showMessage(box, message, isError = true) {
            box.textContent = message;
            box.className = 'fade-in p-4 rounded-md text-sm';
            if (isError) {
                box.classList.add('bg-red-100', 'dark:bg-red-900', 'text-red-700', 'dark:text-red-200');
            } else {
                box.classList.add('bg-green-100', 'dark:bg-green-900', 'text-green-700', 'dark:text-green-200');
            }
            box.classList.remove('hidden');
        }

        function hideMessage(box) {
            box.classList.add('hidden');
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            hideMessage(messageBox);
            isForgotPasswordMode = false;
            passwordField.classList.remove('hidden');
            passwordInput.required = true;

            if (isLoginMode) {
                formTitle.textContent = 'Sign in to your account';
                toggleFormBtn.textContent = 'create a new account';
                submitButton.textContent = 'Sign In';
                forgotPasswordBtn.classList.remove('hidden');
            } else {
                formTitle.textContent = 'Create a new account';
                toggleFormBtn.textContent = 'sign in instead';
                submitButton.textContent = 'Create Account';
                forgotPasswordBtn.classList.add('hidden');
            }
        }

        function toggleForgotPasswordMode() {
            isForgotPasswordMode = !isForgotPasswordMode;
            hideMessage(messageBox);

            if (isForgotPasswordMode) {
                formTitle.textContent = 'Reset your password';
                submitButton.textContent = 'Send Reset Email';
                passwordField.classList.add('hidden');
                passwordInput.required = false;
                toggleFormBtn.textContent = 'back to sign in';
                isLoginMode = true;
            } else {
                formTitle.textContent = 'Sign in to your account';
                submitButton.textContent = 'Sign In';
                passwordField.classList.remove('hidden');
                passwordInput.required = true;
                toggleFormBtn.textContent = 'create a new account';
            }
        }

        function showMainView(viewName) {
            loadingContainer.classList.add('hidden');
            loggedOutContainer.classList.add('hidden'); // NEW
            appContainer.classList.add('hidden');

            if (viewName === 'loading') {
                loadingContainer.classList.remove('hidden');
            } else if (viewName === 'auth') {
                loggedOutContainer.classList.remove('hidden'); // NEW
                showLoggedOutView('login'); // NEW
                isLoginMode = true;
                isForgotPasswordMode = false;
                toggleAuthMode();
                toggleAuthMode();
            } else if (viewName === 'app') {
                appContainer.classList.remove('hidden');
            }
        }
        
        // NEW: Toggle between Login and Gallery on logged-out screen
        function showLoggedOutView(viewName) {
            if (viewName === 'login') {
                authContainer.classList.remove('hidden');
                galleryView.classList.add('hidden');
                authNavLogin.classList.add('active');
                authNavGallery.classList.remove('active');
            } else if (viewName === 'gallery') {
                authContainer.classList.add('hidden');
                galleryView.classList.remove('hidden');
                authNavLogin.classList.remove('active');
                authNavGallery.classList.add('active');
                renderGallery(); // Make sure gallery is rendered
            }
        }
        
        function showAppView(viewId) {
            // Hide all *app* views (Profile, Admin)
            appViews.profile.classList.add('hidden');
            appViews.admin.classList.add('hidden');
            // Show the main gallery view
            galleryView.classList.add('hidden');
            
            // Deactivate all *app* nav buttons
            navButtons.profile.classList.remove('active');
            navButtons.admin.classList.remove('active');
            navButtons.gallery.classList.remove('active');
            
            // Show the selected view
            if (appViews[viewId]) {
                appViews[viewId].classList.remove('hidden');
            }
            // Activate the selected button
            if (navButtons[viewId]) {
                navButtons[viewId].classList.add('active');
            }
        }
        
        function detachListeners() {
            console.log('Detaching listeners...');
            listenersUnsubscribe.forEach(unsub => unsub());
            listenersUnsubscribe = [];
        }

        // NEW: Separate gallery listener so it can run on page load
        function setupGalleryListener() {
            if (galleryListenerUnsub) galleryListenerUnsub(); // Detach old one if exists

            const galleryColRef = collection(db, "gallery");
            const qGallery = query(galleryColRef, orderBy("createdAt", "desc"));
            galleryListenerUnsub = onSnapshot(qGallery, (querySnapshot) => {
                console.log('Gallery data updated.');
                galleryImages = []; // Clear old images
                querySnapshot.forEach((doc) => {
                    galleryImages.push(doc.data());
                });
                renderGallery(); // Re-render the gallery
            }, (error) => {
                console.error("Error listening to gallery:", error);
                galleryLoading.textContent = "Error loading gallery.";
            });
        }
        
        function setupRealtimeListeners(userId) {
            detachListeners(); // This will clear admin listeners
            
            // 1. Listen for user document
            const userDocRef = doc(db, "users", userId);
            const unsubUser = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    console.log('User data updated:', currentUserData);
                    
                    profileEmail.textContent = currentUserData.email;
                    profileUid.textContent = userId;
                    profileCoins.textContent = currentUserData.coins;
                    
                    if (currentUserData.isAdmin) {
                        navButtons.admin.classList.remove('hidden');
                        adminAddCoinsBtn.disabled = false;
                        setupAdminListeners(); // Start admin listeners
                    } else {
                        navButtons.admin.classList.add('hidden');
                        adminAddCoinsBtn.disabled = true;
                    }

                } else {
                    console.error("User document not found!");
                }
            }, (error) => {
                console.error("Error listening to user doc:", error);
            });
            listenersUnsubscribe.push(unsubUser);
        }

        // Admin Listeners
        function setupAdminListeners() {
            // 1. Listen for ALL users
            const usersColRef = collection(db, "users");
            const qUsers = query(usersColRef, orderBy("createdAt", "desc"));

            const unsubAdminUsers = onSnapshot(qUsers, (querySnapshot) => {
                console.log('Admin: All users updated.');
                adminUsersList.innerHTML = '';
                if (querySnapshot.empty) {
                    adminNoUsers.textContent = 'No users found.';
                    adminUsersList.appendChild(adminNoUsers);
                } else {
                    querySnapshot.forEach((doc) => {
                        const user = doc.data();
                        const userEl = createUserElement(user, doc.id);
                        adminUsersList.appendChild(userEl);
                    });
                }
            }, (error) => {
                console.error("Admin: Error listening to users:", error);
                adminNoUsers.textContent = 'Error loading users. Check permissions.';
            });
            listenersUnsubscribe.push(unsubAdminUsers);
        }
        
        // --- Gallery Slideshow Functions ---
        
        function renderGallery() {
            // Clear existing slides
            slideshowContainer.innerHTML = '';
            slideshowContainer.appendChild(galleryLoading);
            slideshowContainer.appendChild(prevSlideBtn);
            slideshowContainer.appendChild(nextSlideBtn);

            if (galleryImages.length === 0) {
                galleryLoading.textContent = 'Gallery is empty. Admin can upload images.';
                prevSlideBtn.classList.add('hidden');
                nextSlideBtn.classList.add('hidden');
                slideDescription.textContent = '';
                return;
            }
            
            galleryLoading.textContent = '';
            prevSlideBtn.classList.remove('hidden');
            nextSlideBtn.classList.remove('hidden');

            galleryImages.forEach((imgData, index) => {
                const slide = document.createElement('div');
                slide.className = 'slide';
                if (index === 0) slide.classList.add('active');
                
                const img = document.createElement('img');
                img.src = imgData.imageUrl;
                img.alt = imgData.description;
                img.className = 'w-full h-auto object-cover rounded-lg shadow-md';
                
                slide.appendChild(img);
                slideshowContainer.prepend(slide);
            });
            
            currentSlideIndex = 0; // Always reset to first slide on render
            showSlide(currentSlideIndex);
        }
        
        function showSlide(index) {
            const slides = document.querySelectorAll('#slideshow-container .slide');
            if (!slides || slides.length === 0) return;
            
            // Wrap index
            if (index >= slides.length) currentSlideIndex = 0;
            if (index < 0) currentSlideIndex = slides.length - 1;
            
            slides.forEach(slide => slide.classList.remove('active'));
            
            slides[currentSlideIndex].classList.add('active');
            slideDescription.textContent = galleryImages[currentSlideIndex].description;
        }
        
        function nextSlide() {
            showSlide(++currentSlideIndex);
        }
        
        function prevSlide() {
            showSlide(--currentSlideIndex);
        }

        // Helper to create user HTML elements for admin
        function createUserElement(user, userId) {
            const userEl = document.createElement('div');
            userEl.className = 'p-3 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm';
            
            const email = document.createElement('p');
            email.textContent = user.email;
            email.className = 'font-bold text-md text-indigo-600 dark:text-indigo-400';
            if (user.isAdmin) {
                email.textContent += ' (Admin)';
                email.classList.add('text-yellow-500');
            }

            const meta = document.createElement('p');
            meta.textContent = `Coins: ${user.coins}`;
            meta.className = 'text-sm text-gray-700 dark:text-gray-300';
            
            const uid = document.createElement('p');
            uid.textContent = `ID: ${userId}`;
            uid.className = 'text-xs font-mono text-gray-500 dark:text-gray-400';
            
            userEl.appendChild(email);
            userEl.appendChild(meta);
            userEl.appendChild(uid);
            
            return userEl;
        }

        // Admin function to add coins to a user
        async function addCoinsToUser(userId, amount) {
            const userDocRef = doc(db, "users", userId);
            adminAddCoinsBtn.disabled = true;
            adminAddCoinsBtn.textContent = "Adding...";
            try {
                await updateDoc(userDocRef, {
                    coins: increment(amount)
                });
                alert(`Successfully added ${amount} coins to user ${userId}`);
                adminUserIdInput.value = '';
                adminCoinAmountInput.value = '';
            } catch (error) {
                console.error("Error adding coins:", error);
                alert("Failed to add coins. Check User ID and permissions.");
            } finally {
                adminAddCoinsBtn.disabled = false;
                adminAddCoinsBtn.textContent = "Add Coins";
            }
        }

        // --- 8. Event Listeners ---

        toggleFormBtn.addEventListener('click', () => {
            if (isForgotPasswordMode) {
                toggleForgotPasswordMode();
            } else {
                toggleAuthMode();
            }
        });

        forgotPasswordBtn.addEventListener('click', toggleForgotPasswordMode);

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage(messageBox);

            const email = authForm.email.value;
            const password = authForm.password.value;
            
            submitButton.disabled = true;

            if (isForgotPasswordMode) {
                submitButton.textContent = 'Sending...';
                try {
                    await sendPasswordResetEmail(auth, email);
                    // UPDATED: Spam folder tip
                    showMessage(messageBox, 'Password reset email sent! Please check your inbox (and spam folder).', false);
                } catch (error) {
                    console.error('Password Reset Error:', error);
                    let friendlyMessage = 'Failed to send reset email. Is the email correct?';
                    if (error.code === 'auth/user-not-found') {
                        friendlyMessage = 'No user found with this email address.';
                    }
                    showMessage(messageBox, friendlyMessage, true);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Send Reset Email';
                }
                return;
            }

            submitButton.textContent = isLoginMode ? 'Signing In...' : 'Creating...';
            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    console.log('User created:', userCredential.user);
                    
                    const userDocRef = doc(db, "users", userCredential.user.uid);
                    await setDoc(userDocRef, {
                        email: userCredential.user.email,
                        coins: 0,
                        createdAt: serverTimestamp(),
                        isAdmin: false
                    });
                    console.log('User document created in Firestore');
                    
                    showMessage(messageBox, 'Account created successfully! You are now logged in.', false);
                }
            } catch (error) {
                console.error('Auth Error:', error.code, error.message);
                let friendlyMessage = 'An unknown error occurred.';
                switch(error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        friendlyMessage = 'Invalid email or password.';
                        break;
                    case 'auth/email-already-in-use':
                        friendlyMessage = 'This email address is already in use.';
                        break;
                    case 'auth/weak-password':
                        friendlyMessage = 'The password is too weak (must be at least 6 characters).';
                        break;
                    case 'auth/invalid-email':
                        friendlyMessage = 'Please enter a valid email address.';
                        break;
                    case 'auth/network-request-failed':
                        friendlyMessage = 'Network error. Please check your connection.';
                        break;
                }
                showMessage(messageBox, friendlyMessage, true);
            } finally {
                submitButton.disabled = false;
                if (isForgotPasswordMode) {
                    submitButton.textContent = 'Send Reset Email';
                } else {
                    submitButton.textContent = isLoginMode ? 'Sign In' : 'Create Account';
                }
            }
        });

        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });
        
        // --- App Navigation ---
        // NEW: Moved Gallery to be part of the Profile view nav
        navButtons.gallery.addEventListener('click', () => {
             // This is tricky. We show the main app container,
             // then manually show the gallery view and hide the others.
            showMainView('app'); // Show the logged-in container
            appViews.profile.classList.add('hidden');
            appViews.admin.classList.add('hidden');
            galleryView.classList.remove('hidden'); // Show gallery
            
            navButtons.gallery.classList.add('active');
            navButtons.profile.classList.remove('active');
            navButtons.admin.classList.remove('active');
        });
        navButtons.profile.addEventListener('click', () => showAppView('profile'));
        navButtons.admin.addEventListener('click', () => showAppView('admin'));
        
        // NEW: Logged-out Nav Listeners
        authNavGallery.addEventListener('click', () => showLoggedOutView('gallery'));
        authNavLogin.addEventListener('click', () => showLoggedOutView('login'));
        
        // Gallery slide listeners
        prevSlideBtn.addEventListener('click', prevSlide);
        nextSlideBtn.addEventListener('click', nextSlide);
        
        // Admin "Add Coins" button listener
        adminAddCoinsBtn.addEventListener('click', async () => {
            const userId = adminUserIdInput.value;
            const amount = parseInt(adminCoinAmountInput.value, 10);

            if (!userId || isNaN(amount)) {
                alert("Please enter a User ID and a valid number for the amount.");
                return;
            }

            if (currentUserData && currentUserData.isAdmin) {
                await addCoinsToUser(userId, amount);
            } else {
                alert("You do not have permission to do this.");
            }
        });
        
        // Admin Gallery Upload form listener
        galleryUploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = galleryImageInput.files[0];
            const description = galleryDescriptionInput.value;
            
            if (!file || !description) {
                showMessage(galleryUploadMessage, 'Please select a file and add a description.', true);
                return;
            }
            
            galleryUploadBtn.disabled = true;
            galleryUploadBtn.textContent = 'Uploading...';
            hideMessage(galleryUploadMessage);
            
            try {
                const storageRef = ref(storage, 'gallery/' + Date.now() + '-' + file.name);
                await uploadBytes(storageRef, file);
                const imageUrl = await getDownloadURL(storageRef);
                
                await addDoc(collection(db, 'gallery'), {
                    imageUrl: imageUrl,
                    description: description,
                    createdAt: serverTimestamp()
                });
                
                showMessage(galleryUploadMessage, 'Image uploaded successfully!', false);
                galleryUploadForm.reset();
                
            } catch (error) {
                console.error("Gallery Upload Error:", error);
                showMessage(galleryUploadMessage, 'Upload failed. Check console and permissions.', true);
            } finally {
                galleryUploadBtn.disabled = false;
                galleryUploadBtn.textContent = 'Upload Image';
            }
        });

        // --- 9. Authentication State Observer ---
        onAuthStateChanged(auth, (user) => {
            console.log('Auth state changed. User:', user ? user.uid : 'null');
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                setupRealtimeListeners(user.uid); // This sets up user/admin listeners
                showMainView('app');
                // Default to gallery view on login
                navButtons.gallery.click(); // Programmatically click the gallery button
            } else {
                // User is signed out
                currentUserId = null;
                currentUserData = null;
                detachListeners();
                showMainView('auth');
                showLoggedOutView('gallery'); // Default to gallery on logged out
            }
        });
        
        // --- Initial Load ---
        setupGalleryListener(); // NEW: Load gallery immediately
        showMainView('loading');

    </script>
</body>
</html>